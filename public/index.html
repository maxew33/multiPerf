<!-- <!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Audit Lighthouse</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    textarea { width: 100%; height: 150px; }
    iframe { width: 100%; height: 600px; border: none; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Audit Lighthouse Web</h1>
  <form id="audit-form">
    <label>Entrez les URLs (une par ligne) :</label><br>
    <textarea name="urls"></textarea><br>
    <button type="submit">Lancer l'audit</button>
  </form>

  <div id="results"></div>
  <div id="loader" style="display:none; margin-top: 1rem;">
    <p>üïê Audit en cours... Veuillez patienter.</p>
  </div>
  
  <script>
    document.getElementById('audit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
  
      const textarea = e.target.elements.urls;
      const urls = textarea.value.trim().split('\n').filter(Boolean);
      const loader = document.getElementById('loader');
      const results = document.getElementById('results');
  
      if (!urls.length) {
        alert('Veuillez entrer au moins une URL.');
        return;
      }
  
      // Affiche le loader
      loader.style.display = 'block';
      results.innerHTML = '';
  
      try {
        const response = await fetch('/audit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ urls })
        });
  
        const data = await response.json();
  
        // Cache le loader
        loader.style.display = 'none';
  
        if (!data.reports.length) {
          results.innerHTML = '<p>Aucun rapport g√©n√©r√©.</p>';
          return;
        }
  
        data.reports.forEach(report => {
          const iframe = document.createElement('iframe');
          iframe.src = report;
          results.appendChild(iframe);
        });
      } catch (error) {
        loader.style.display = 'none';
        console.error('Erreur:', error);
        alert("Erreur lors de l'audit. Consultez la console.");
      }
    });
  </script>
  
</body>
</html> -->

<!-- 
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Audit Lighthouse</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    textarea { width: 100%; height: 150px; }
    table { width: 100%; border-collapse: collapse; margin-top: 2rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    th { background-color: #f2f2f2; }
    .env-title { background-color: #eee; font-weight: bold; }
    .url-row { background-color: #f9f9f9; font-weight: bold; }
    .loader { margin-top: 1rem; font-weight: bold; }
    .small { font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>Audit Lighthouse Web</h1>
  <form id="audit-form">
    <label>Entrez les URLs (une par ligne) :</label><br>
    <textarea name="urls" placeholder="https://example.com\nhttps://autresite.com"></textarea><br>
    <button type="submit">Lancer l'audit</button>
  </form>

  <div id="loader" class="loader" style="display:none;">üïê Audit en cours... Veuillez patienter.</div>
  <div id="results"></div>

  <script>
    document.getElementById('audit-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const textarea = e.target.elements.urls;
      const urls = textarea.value.trim().split('\n').filter(Boolean);
      const loader = document.getElementById('loader');
      const results = document.getElementById('results');

      if (!urls.length) {
        alert('Veuillez entrer au moins une URL.');
        return;
      }

      loader.style.display = 'block';
      results.innerHTML = '';

      try {
        const response = await fetch('/audit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ urls })
        });

        const data = await response.json();
        loader.style.display = 'none';

        if (!data.results?.length) {
          results.innerHTML = '<p>Aucun rapport g√©n√©r√©.</p>';
          return;
        }

        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>URL</th>
              <th>Environnement</th>
              <th>Performance</th>
              <th>SEO</th>
              <th>Accessibilit√©</th>
              <th>Rapports</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');

        data.results.forEach(site => {
          const { url, audits } = site;

          const firstRow = document.createElement('tr');
          firstRow.className = 'url-row';
          firstRow.innerHTML = `<td colspan="6">${url}</td>`;
          tbody.appendChild(firstRow);

          Object.entries(audits).forEach(([env, result]) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td></td>
              <td>${env}</td>
              <td>${result.average.performance}</td>
              <td>${result.average.seo}</td>
              <td>${result.average.accessibility}</td>
              <td class="small">
                ${result.reports.map(link => `<a href="${link}" target="_blank">rapport</a>`).join(', ')}
              </td>
            `;
            tbody.appendChild(row);
          });
        });

        results.appendChild(table);
      } catch (error) {
        loader.style.display = 'none';
        console.error('Erreur:', error);
        alert("Erreur lors de l'audit. Consultez la console.");
      }
    });
  </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Audit Lighthouse - R√©sultats</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      max-width: 900px;
      margin: auto;
    }
    textarea {
      width: 100%;
      height: 150px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: center;
    }
    th {
      background: #f5f5f5;
    }
    caption {
      font-weight: bold;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    .loader {
      margin-top: 1rem;
      font-style: italic;
    }
    a.report-link {
      color: #0366d6;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h1>Audit Lighthouse Web</h1>
  <form id="audit-form">
    <label>Entrez les URLs (une par ligne) :</label><br />
    <textarea name="urls" placeholder="https://example.com"></textarea><br />
    <button type="submit">Lancer l'audit</button>
  </form>

  <div id="loader" class="loader" style="display:none;">üïê Audit en cours... Veuillez patienter.</div>
  <div id="results"></div>

  <script>
    function formatMs(ms) {
      if (ms == null || isNaN(ms)) return '‚Äî';
      if (ms > 1000) return (ms / 1000).toFixed(2) + ' s';
      return Math.round(ms) + ' ms';
    }

    function formatCls(value) {
      if (value == null || isNaN(value)) return '‚Äî';
      return value.toFixed(3);
    }

    document.getElementById('audit-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const textarea = e.target.elements.urls;
      const urls = textarea.value.trim().split('\n').filter(Boolean);
      const loader = document.getElementById('loader');
      const results = document.getElementById('results');

      if (!urls.length) {
        alert('Veuillez entrer au moins une URL.');
        return;
      }

      loader.style.display = 'block';
      results.innerHTML = '';

      try {
        const response = await fetch('/audit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ urls })
        });

        const data = await response.json();
        loader.style.display = 'none';

        if (!data.results || data.results.length === 0) {
          results.innerHTML = '<p>Aucun r√©sultat d\'audit disponible.</p>';
          return;
        }

        // Cr√©ation du tableau
        const table = document.createElement('table');
        table.innerHTML = `
          <caption>R√©sultats Moyens des Audits Lighthouse (3 passes)</caption>
          <thead>
            <tr>
              <th>URL</th>
              <th>Performance</th>
              <th>SEO</th>
              <th>Accessibilit√©</th>
              <th>Bonnes Pratiques</th>
              <th>FCP</th>
              <th>LCP</th>
              <th>TBT</th>
              <th>Speed Index</th>
              <th>CLS</th>
              <th>Rapports</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');

        data.results.forEach(item => {
          const tr = document.createElement('tr');

          // Format des rapports en liens cliquables
          const reportsLinks = item.reports
            .map((r, i) => `<a class="report-link" href="${r}" target="_blank" rel="noopener noreferrer">Rapport ${i + 1}</a>`)
            .join('<br>');

          tr.innerHTML = `
            <td>${item.url}</td>
            <td>${item.averageScores.performance.toFixed(1)}%</td>
            <td>${item.averageScores.seo.toFixed(1)}%</td>
            <td>${item.averageScores.accessibility.toFixed(1)}%</td>
            <td>${item.averageScores.bestPractices.toFixed(1)}%</td>
            <td>${formatMs(item.averageMetrics.fcp)}</td>
            <td>${formatMs(item.averageMetrics.lcp)}</td>
            <td>${formatMs(item.averageMetrics.tbt)}</td>
            <td>${formatMs(item.averageMetrics.si)}</td>
            <td>${formatCls(item.averageMetrics.cls)}</td>
            <td>${reportsLinks}</td>
          `;

          tbody.appendChild(tr);
        });

        results.appendChild(table);
      } catch (error) {
        loader.style.display = 'none';
        console.error('Erreur:', error);
        alert("Erreur lors de l'audit. Consultez la console.");
      }
    });
  </script>
</body>
</html>

